---
title: TCP拥塞控制
id: 7
---

端到端的拥塞控制机制

- 路由器不向主机有关拥塞的反馈信息
  - 路由器的负担较轻
  - 符合网络核心简单的 TCP/IP架构原则
- 端系统根据自身得到的信息 ，判断是否发生拥塞，从而采取动作


**拥塞感知（发送端如何探测到拥塞）**

- 某个段超时了（丢失事件 ）：拥塞

  - 超时时间到，某个段的确认没有来
  - 原因1：网络拥塞（某个路由器缓冲区没空间了，被丢弃）概率大
  - 原因2：出错被丢弃了（各级错误，没有通过校验，被丢弃）概率小
  - 一旦超时，就认为拥塞了，有一定误判，但是总体控制方向是对的

- 有关某个段的3次重复ACK：轻微拥塞

  ![image-20210821091932885](/img/Network/计算机网络/传输层/image-20211228184915293.png)

  - 段的第1个ack，正常，确认绿段，期待红段
  - 段的第2个重复ack，意味着红段的后一段收到了，蓝段乱序到达
  - 段的第2、3、4个ack重复，意味着红段的后第2、3、4个段收到了 ，橙段乱序到达，同时红段丢失的可能性很大（后面3个段都到了， 红段都没到）
  - 网络这时还能够进行一定程度的传输，拥塞但情况要比第一种好



**速率控制方法（如何控制发送端发送的速率）**

- 维持一个拥塞窗口的值：Congestion window，cwnd

- 发送端限制已发送但是未确认的数据量（的上限）：$LastByteSent-LastByteAcked\leq \min\{cwnd,rwnd\}$

- 从而粗略地控制发送方的往网络中注入的速率：$rate\approx \frac{cwnd}{RTT}$

- cwnd是动态的，是感知到的网络拥塞程度的函数

  - 超时或者3个重复ack，cwnd 下降

    - 超时时：cwnd降为1MSS，进入SS阶段然后再倍增到 cwnd/2（每个RTT），从而进入CA（拥塞避免）阶段

      > MSS（最大报文段长度）=MTU - IP head- TCP head

    - 3个重复ack ：cwnd降为cwnd/2，CA阶段

  - 否则（正常收到Ack，没有发送以上情况）：cwnd上升

    - SS阶段：加倍增加（每个RTT）
    - CA阶段：线性增加（每个RTT）

- 联合控制的方法

  - 发送端控制发送但是未确认的量同时也不能够超过接收窗口，满足流量控制要求
  - 同时满足拥塞控制和流量控制要求



**拥塞控制策略**

TCP 慢启动（slow-start，SS）

- 连接刚建立，cwnd = 1 MSS
- 可用带宽可能接近MSS/RTT，此时应该尽快加速，到达希望的速率
- 当连接开始时，指数性增加发送速率，直到发生丢失的事件
  - 启动初值很低
  - 增加速度很快
- 当连接开始时，指数性增加（每个RTT）发送速率直到发生丢失事件
  - 每一个RTT，cwnd加倍
  - 每收到一个ACK时，cwnd加1
  - 慢启动阶段：只要不超时或3个重复ack，一个RTT，cwnd加倍
- 总结：初始速率很慢，但是加速却是指数性的
  - 指数增加，SS时间很短，长 期来看可以忽略
- 例子：喝酒



TCP 拥塞控制：AIMD

- 乘性减：丢失事件后将cwnd降为1，将cwnd/2作为阈值，进入慢启动阶段（倍增直到 cwnd/2） 
- 加性增：当cwnd>阈值时，一个RTT如没有发生丢失事件，将cwnd加1MSS进行探测
- 在超时之前，当cwnd变成上次发生超时的窗口的一半，将指数性增长变成线性![image-20210821091932885](/img/Network/计算机网络/传输层/image-20210821091932885.png)

- 变量：Threshold

- 出现丢失，Threshold设置成cwnd的1/2



TCP拥塞控制总结：

- 当cwnd＜Threshold，发送端处于慢启动阶段（ slow-start）, 窗口指数性增长
- 当cwnd > Threshold，发送端处于拥塞避免阶段 （congestion-avoidance）, 窗口线性增长
- 当收到三个重复的ACKs（triple duplicate ACK），Threshold设置成 cwnd/2，cwnd = Threshold+3
- 当超时事件发生时timeout，Threshold = cwnd/2  cwnd=1MSS，进入SS阶段

| 事件                                   | 状态           | TCP 发送端行为                                       | 解释                                        |
| -------------------------------------- | -------------- | ---------------------------------------------------- | ------------------------------------------- |
| 以前没有收到 ACK的data  被ACKed        | 慢启动 (SS)    | cwnd = cwnd + MSS if（cwnd > Threshold）状态变成“CA” | 每一个RTT cwnd 加倍                         |
| 以前没有收到 ACK的data  被ACKed        | 拥塞避 免 (CA) | cwnd = cwnd + MSS *（MSS/cwnd）                      | 加性增加，每一个RTT对 cwnd 加一个1 MSS      |
| 通过收到3个重 复的ACK，发现 丢失的事件 | SS or CA       | Threshold = cwnd/2，cwnd = Threshold+3               | 快速重传，实现乘性的减. cwnd 没有变成1  MSS |
| 超时                                   | SS or CA       | Threshold = cwnd/2，cwnd = 1MSS，状态变为SS          | 进入slow start                              |
| 重复的 ACK                             | SS or CA       | 对被ACKed 的segment，增加重复ACK的计数               | cwnd和Threshold不变                         |



TCP 吞吐量：忽略慢启动阶段，假设发送端总有数据传输

![image-20210821094010456](/img/Network/计算机网络/传输层/image-20210821094010456.png)

- W：发生丢失事件时的窗口尺寸（单位：字节）

- 平均窗口尺寸：3/4W

- 平均吞吐量：RTT时间吞吐3/4W

  > $T=\frac{\frac{W}{2}+W}{2RTT}=\frac{3}{4}\frac{W}{RTT}$







**TCP公平性**

若K个TCP会话分享一个链路带宽为R的瓶颈，每一个会话的有效带宽为 R/K

2个竞争的TCP会话

- 加性增加，斜率为1, 吞吐量增加
- 乘性减，吞吐量比例减少



公平性和 UDP

- 多媒体应用通常不是用 TCP，应用发送的数据速率希望不受拥塞控制的节制
- 使用UDP：音视频应用泵出数据的速率是恒定的, 忽略数据的丢失
- 研究领域：TCP友好性



公平性和并行TCP连接

- 2个主机间可以打开多个并行的TCP连接
- 如Web浏览器

